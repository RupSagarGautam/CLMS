{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  {% include "layouts/header.html" %}
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>

  <!-- Dashboard CSS and fonts -->
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />

  <!-- FontAwesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- ApexCharts CDN -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body>
  <div class="dashboard-container">
    <header>
      <h1>Dashboard</h1>
      <p>Welcome, Admin!</p>
    </header>

    <form method="get" id="filterForm" class="filter-section">
      <label for="visitType">Visit Type:</label>
      <select id="visitType" name="visit_type" onchange="document.getElementById('filterForm').submit();">
        <option value="All" {% if selected_type == "All" %}selected{% endif %}>All</option>
        {% for vt in visit_types %}
          <option value="{{ vt }}" {% if selected_type == vt %}selected{% endif %}>{{ vt }}</option>
        {% endfor %}
      </select>

      <label for="startDate">Start Date:</label>
      <input type="date" id="startDate" name="start_date" value="{{ start_date|default:'' }}">

      <label for="endDate">End Date:</label>
      <input type="date" id="endDate" name="end_date" value="{{ end_date|default:'' }}">

      <button type="submit">Apply Filters</button>
    </form>

    <section class="charts">
      <div class="chart-placeholder" id="lineChartContainer">
        <h2>Visits Over Time</h2>
        <div id="lineChart" style="height: 400px;"></div>
      </div>

      <div class="chart-placeholder" id="barChartContainer">
        <h2>Distribution by Type</h2>
        <div id="barChart" style="height: 400px;"></div>
      </div>
    </section>

    <section class="recent-visits">
      <h2>ðŸ—‚ Recent Visits</h2>
      <table>
        <thead>
          <tr>
            <th>Visit Type</th>
            <th>Date</th>
            <th>Count</th>
          </tr>
        </thead>
        <tbody>
          {% for visit in detailed_visits %}
            <tr>
              <td>{{ visit.visit_type.name }}</td>
              <td>{{ visit.date }}</td>
              <td>{{ visit.count }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="3">No visits found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  </div>

  <!-- Pass Django context data to JS -->
  <script>
    window.allDates = {{ dates|safe }};
    window.allVisitCounts = {{ totals|safe }};
    window.typeLabels = {{ type_labels|safe }};
    window.typeCounts = {{ type_counts|safe }};
  </script>


  <!-- Line Chart -->
  <script>

    var lineChartOptions = {
      chart: {
        type: 'line',
        height: 400,
        toolbar: { show: false }
      },
      series: [{
        name: 'Visits',
        data: window.allVisitCounts  // corrected from totalsData
      }],
      xaxis: {
        categories: window.allDates,  // added categories for x-axis
        labels: {
          style: { fontSize: '12px', colors: '#333' }
        }
      },
      stroke: {
        curve: 'smooth',
        width: 4,
        colors: ['#28a745']
      },
      markers: {
        size: 5,
        colors: ['#28a745'],
        strokeColors: '#fff',
        strokeWidth: 2
      },
      colors: ['#28a745'],
      tooltip: {
        enabled: true,
        x: { format: 'dd MMM' }
      },
      grid: {
        borderColor: '#eee',
        row: {
          colors: ['#f9f9f9', 'transparent'],
          opacity: 0.5
        }
      }
    };

    var lineChart = new ApexCharts(document.querySelector("#lineChart"), lineChartOptions);
    lineChart.render();
  </script>

  <!-- Bar Chart -->
  <script>
    var typeLabels = window.typeLabels;
    var typeCounts = window.typeCounts;

    var barChartOptions = {
      chart: {
        type: 'bar',
        height: 400,
        toolbar: { show: false }
      },
      series: [{
        name: 'Visit Count',
        data: typeCounts
      }],
      xaxis: {
        categories: typeLabels,
        labels: {
          style: { fontSize: '12px', colors: '#333' }
        }
      },
      colors: ['#66bb6a', '#81c784', '#a5d6a7', '#c8e6c9'],
      plotOptions: {
        bar: {
          columnWidth: '50%',
          borderRadius: 4
        }
      },
      tooltip: {
        enabled: true
      },
      grid: {
        borderColor: '#eee',
        row: {
          colors: ['#f9f9f9', 'transparent'],
          opacity: 0.5
        }
      }
    };

    var barChart = new ApexCharts(document.querySelector("#barChart"), barChartOptions);
    barChart.render();
  </script>
</body>
</html>
