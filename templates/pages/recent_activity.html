{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Recent Activity</title>
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
   
</head>
<body>
    {% include "layouts/header.html" %}

        <div style="padding: 2rem;">
        <div class="welcome-main" style="font-size:1.3rem;font-weight:600;color:#31882e;margin-bottom:2rem;">
           <h1> Welcome, {{ user.username }} </h1>
        </div>

    {% if messages %}
        <div class="backend-message">
            {% for message in messages %}
                {{ message }}
            {% endfor %}
        </div>
    {% endif %}

    <div class="recent-activity-wrapper">
        <h2 class="recent-title"><i class="fa-solid fa-chart-simple"></i> Overall Entries  </h2>
        <div class="summary-cards">
            <div class="summary-card">
                <h3>Client Visits</h3>
               <p class="summary-count" data-date="{{ client_visit_latest_time|date:'Y-m-d H:i' }}">{{ total_client_visits }}</p>

            </div>
            <div class="summary-card">
                <h3>Online Class Inquiries</h3>
                <p class="summary-count" data-date="{{ online_inquiries_latest_time|date:'Y-m-d H:i' }}">{{ total_online_inquiries }}</p>
            </div>
            <div class="summary-card">
                <h3>Office Visits</h3>
                <p class="summary-count" data-date="{{ client_visit_latest_time|date:'Y-m-d H:i' }}">{{ total_office_visits }}</p>
            </div>
            <div class="summary-card">
                <h3>College/School Visits</h3>
                <p class="summary-count">{{ total_college_visits }}</p>
            </div>
        </div>

        <div class="visit-types-section">
            <h3 class="section-title"><i class="fa-solid fa-user-tie"></i> Staff Activities</h3>
                <div class="search-container" style="margin-bottom: 1rem;">
                    <input type="text" id="searchInput" placeholder="Search by Username, Model, or Date & Time..." style="width: 100%; padding: 0.5rem; font-size: 1rem;">
                </div>
            {% if recent_staff_activity %}
                <table class="visit-types-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Action</th>
                            <th>Role</th>
                            <th>Model</th>
                            <th>Date & Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in recent_staff_activity %}
                        <tr>
                            <td>{{ entry.user.username }}</td>
                            <td>
                                {% if entry.action_flag == 1 %}
                                    <i class="fa fa-plus-circle" aria-hidden="true"></i> Added
                                {% elif entry.action_flag == 2 %}
                                    <i class="fa fa-pencil" aria-hidden="true"></i> Changed
                                {% elif entry.action_flag == 3 %}
                                    <i class="fa fa-trash" aria-hidden="true"></i> Deleted
                                {% else %}
                                    ‚ùî Unknown
                                {% endif %}
                            </td>
                            <td>
                                {% if entry.user.is_superuser %}
                                    Admin
                                {% elif entry.user.is_staff %}
                                    Staff
                                {% else %}
                                    User
                                {% endif %}
                            </td>
                            <td>
                                {% with model_name=entry.content_type.model app_label=entry.content_type.app_label %}
                                    {% if app_label == "staff" %}
                                        {% if model_name == "clientvisit" %}
                                            Client Visit
                                        {% elif model_name == "officevisit" %}
                                            Office Visit
                                        {% elif model_name == "collegevisit" %}
                                            School/College Visit
                                        {% elif model_name == "onlineclassinquiry" %}
                                            Online Class Inquiry
                                        {% else %}
                                            Unknown Staff Model ({{ model_name }})
                                        {% endif %}
                                    {% elif app_label == "auth" and model_name == "user" %}
                                        User
                                    {% else %}
                                        Unknown Model ({{ app_label }}.{{ model_name }})
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td>{{ entry.action_time|date:"Y-m-d H:i" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                {% if not view_all and request.user.is_superuser %}
                    <div class="view-all-btn-wrapper">
                        <a href="?view=all" class="view-all-btn">View All</a>
                    </div>
                {% endif %}
            {% else %}
                <p>No recent staff activities recorded.</p>
            {% endif %}
        </div>
    </div>

    <script>
    document.getElementById('searchInput').addEventListener('input', function () {
        const searchValue = this.value.toLowerCase();
        const rows = document.querySelectorAll('.visit-types-table tbody tr');

        rows.forEach(row => {
            const username = row.cells[0]?.innerText.toLowerCase();
            const model = row.cells[3]?.innerText.toLowerCase();
            const dateTime = row.cells[4]?.innerText.toLowerCase();

            const match = username.includes(searchValue) || 
                          model.includes(searchValue) || 
                          dateTime.includes(searchValue);

            row.style.display = match ? '' : 'none';
        });
    });
</script>

</body>
</html>